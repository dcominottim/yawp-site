





<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="description" content="Since I’ve started mixing YAWP! APIs with some of the new Google Firebase 3.0 features,
specially for my mobile apps, I’ve faced some challenges, mostly because the Firebase + 
Google Cloud integration is pretty new in the market.

">
    
    <meta name="author" content="Fernando Ultremare and YAWP! contributors">
    <meta name="google-site-verification" content="M6k8Ek0uNY4lajqXCtfLutObDtu7H9jDeEU7W35F9nY" />

    <title>YAWP! - YAWP! + Firebase 3.0 + GAE</title>

    <!-- Bootstrap Core CSS - Uses Bootswatch Flatly Theme: http://bootswatch.com/flatly/ -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/assets/css/freelancer.css" rel="stylesheet">
    <link href="/assets/css/yawp.css" rel="stylesheet">
    <link href="/assets/css/github-ribbon.css" rel="stylesheet">
    <link href="/assets/css/guides.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="httpS://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="httpS://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- code formating -->
    <script src="https://cdn.jsdelivr.net/highlight.js/8.9.1/highlight.min.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-54832827-1', 'auto');
    ga('send', 'pageview');

    </script>
    <!-- End Google Analytics -->

    <!-- Begin Inspectlet Embed Code -->
    <script type="text/javascript" id="inspectletjs">
    window.__insp = window.__insp || [];
    __insp.push(['wid', 86703955]);
    (function() {
    function ldinsp(){if(typeof window.__inspld != "undefined") return; window.__inspld = 1; var insp = document.createElement('script'); insp.type = 'text/javascript'; insp.async = true; insp.id = "inspsync"; insp.src = ('https:' == document.location.protocol ? 'https' : 'http') + '://cdn.inspectlet.com/inspectlet.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(insp, x); };
    setTimeout(ldinsp, 500); document.readyState != "complete" ? (window.attachEvent ? window.attachEvent('onload', ldinsp) : window.addEventListener('load', ldinsp, false)) : ldinsp();
    })();
    </script>
    <!-- End Inspectlet Embed Code -->


    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/highlight.js/8.9.1/styles/atelier-cave.light.min.css">
    

    

</head>

<body id="page-top" class="index">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                
                    <a class="navbar-brand" href="/">YAWP!</a>
                
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="main-navbar collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <!-- <li class="page-scroll">
                        <a href="#page-top">Home</a>
                    </li> -->
                    <li class="">
                        <a href="/#portfolio">Features</a>
                    </li>
                    <li class="">
                        <a href="/#kickstart">Kickstart</a>
                    </li>
                    <li class="">
                        <a href="/#community">Community</a>
                    </li>
                    <li class="">
                        <a href="/guides">Guides</a>
                    </li>
                    <li class="active">
                        <a href="/blog">Blog</a>
                    </li>
                    <li>
                        <a href="http://github.com/feroult/yawp" target="_blank">GITHUB&nbsp;&nbsp;<i class="fa fa-github" style="font-size: 1.2em;"></i></a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <div class="container">
    <div id="accordion" class="panel-group">
        <div class="sidebar">
            <div class="panel panel-default">
                <a data-toggle="collapse" href="#getting-started">
                    <div class="panel-heading">
                        <h4 class="panel-title">Recent Posts</h4>
                    </div>
                </a>

                <div id="getting-started" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <ul>
                            
                            <a href="/blog/2016/07/20/new-yawp-javascript-client">
                                <li class="new-yawp-javascript-client">
                                    New YAWP! Javascript Client
                                </li>
                            </a>
                            
                            <a href="/blog/2016/06/06/yawp-firebase-30-appengine">
                                <li class="yawp-firebase-30-appengine">
                                    YAWP! + Firebase 3.0 + GAE
                                </li>
                            </a>
                            
                            <a href="/blog/2016/03/06/release1-5-0">
                                <li class="release1-5-0">
                                    YAWP! 1.5.0 Released
                                </li>
                            </a>
                            
                            <a href="/blog/2016/01/05/release1-4-0">
                                <li class="release1-4-0">
                                    YAWP! 1.4.0 Released
                                </li>
                            </a>
                            
                            <a href="/blog/2015/12/30/semantic-versioning">
                                <li class="semantic-versioning">
                                    Semantic Versioning
                                </li>
                            </a>
                            
                            <a href="/blog/2015/12/24/welcome-to-the-blog">
                                <li class="welcome-to-the-blog">
                                    Welcome to the Blog!
                                </li>
                            </a>
                            
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="guide">
        
            <h1>YAWP! + Firebase 3.0 + GAE</h1>
        
        
        <p>Since I’ve started mixing YAWP! APIs with some of the new Google Firebase 3.0 features,
specially for my mobile apps, I’ve faced some challenges, mostly because the Firebase + 
Google Cloud integration is pretty new in the market.</p>

<!--more-->

<p>One of the really awesome Firebase’s features is its authentication model, which helps linking
different user’s social accounts together, leveraging the Google 
Identity Toolkit with easy to use SDKs for Java, Javascript, Android and iOS.</p>

<p>This is the authentication flow I’m talking about:</p>

<ol>
  <li>User access the app, either Web, Android or IOS;</li>
  <li>Firebase SDK redirects to the sign-in provider: Google, Facebook, etc;</li>
  <li>User authorizes the app at the provider OAuth page;</li>
  <li>User is redirected to Firebase identity endpoint;</li>
  <li>Firebase links the user account and generates a JWT access token (returned to app);</li>
  <li>User access YAWP! endpoints using the JWT token;</li>
  <li>YAWP! APIs verifies if the JWT token is valid and legit;</li>
</ol>

<h3 id="the-problem">The Problem</h3>

<p>To execute the step 7, one could easily use the Firebase Java SDK, as 
described in this <a href="https://firebase.google.com/docs/auth/server#verify_id_tokens">guide</a>, like this:</p>

<pre><code class="language-java">String idToken;  // Get the user's ID token from the client app

FirebaseAuth.getInstance().verifyIdToken(idToken)
    .addOnSuccessListener(new OnSuccessListener&lt;FirebaseToken&gt;() {
        @Override
        public void onSuccess(FirebaseToken decodedToken) {
          String uid = decodedToken.getUid();
          // ...
        }
});
</code></pre>

<p>The problem is that if you try to do this on Appengine, you will get the following error:</p>

<pre><code class="language-java">java.lang.IllegalStateException: This feature is only available to backend instances.
</code></pre>

<p>Saying that the SDK can’t be used inside the regular fronted instances because
it uses some <strong>java.util.concurrent</strong> features that are only supported by the backend 
environment.</p>

<h3 id="the-solution">The Solution</h3>

<p>One solution could be deploy your YAWP! API as backend API, but this will create other kind
of problems, different pricing, scalability, etc.</p>

<p>So, to solve the problem, one should verify the token manually. To do so, I’ve got the details 
of the Firebase JWT architecture from 
<a href="http://stackoverflow.com/questions/37408684/is-it-still-possible-to-do-server-side-verification-of-tokens-in-firebase-3/37492640#37492640">this answer</a> at the
Stackoverflow.</p>

<p>The main idea is to verify the Firebase JWT by checking it against one of the
Google Cloud’s pubic certificates. To deal with the low-level details of the JWT architecture
we are going to be using the <a href="https://github.com/jwtk/jjwt">JJWT Library</a>.</p>

<p>The following class has a <strong>verifyIdToken(token)</strong> method that assembles together all the details
described at the previous links:</p>

<pre><code class="language-java">public class AppengineFirebaseAuth {

    private static final String APP_ID = "YOUR_APP_ID";

    public static AppengineFirebaseToken verifyIdToken(String token) {
        Map&lt;String, String&gt; publicKeys = GooglePublicKeys.getKeys();

        for (String kid : publicKeys.keySet()) {
            String publicKey = publicKeys.get(kid);

            try {
                Jws&lt;Claims&gt; claimsJws = verifyIdTokey(token, kid, publicKey);
                return new AppengineFirebaseToken(claimsJws.getBody());
            } catch (SignatureException e) {
                continue; // try next key
            } catch (ExpiredJwtException e) {
                throw new InvalidFirebaseTokenException(e.getMessage());
            }
        }

        throw new InvalidFirebaseTokenException("No Google public keys for JWT Token");
    }

    private static Jws&lt;Claims&gt; verifyIdTokey(String token, String kid, String publicKey) {
        PublicKey pk = createPk(publicKey);
        Jws&lt;Claims&gt; claimsJws = Jwts.parser().setSigningKey(pk).parseClaimsJws(token);
        validate(claimsJws, kid);
        return claimsJws;
    }

    private static void validate(Jws&lt;Claims&gt; claimsJws, String kid) {
        if (claimsJws.getHeader().getAlgorithm().equals("RS256") &amp;&amp;
                claimsJws.getBody().getAudience().equals(APP_ID) &amp;&amp;
                claimsJws.getBody().getIssuer().equals("https://securetoken.google.com/" + APP_ID) &amp;&amp;
                claimsJws.getBody().getSubject() != null &amp;&amp;
                claimsJws.getHeader().getKeyId().equals(kid)) {
            return;
        }
        throw new InvalidFirebaseTokenException("Invalid Firebase Id Token");
    }

    private static PublicKey createPk(String publicKey) {
        try {
            CertificateFactory cf = CertificateFactory.getInstance("X.509");
            InputStream stream = new ByteArrayInputStream(publicKey.getBytes("UTF-8"));
            java.security.cert.Certificate cert = cf.generateCertificate(stream);
            return cert.getPublicKey();
        } catch (CertificateException | UnsupportedEncodingException e) {
            throw new RuntimeException(e);
        }
    }
}
</code></pre>

<p>Finally, the Google Cloud public certificates need to be fetched from time to time, since
they are always changing to minimize security isssues. The following class will deal
with this:</p>

<pre><code class="language-java">public class GooglePublicKeys {

    private static final String GOOGLE_PUBLIC_KEYS = "https://www.googleapis.com/robot/v1/metadata/x509/securetoken@system.gserviceaccount.com";

    private static final int ONE_DAY = 1000 * 60 * 60 * 24;

    private static GooglePublicKeys instance;

    private long timestamp;

    private Map&lt;String, String&gt; keys;

    private GooglePublicKeys() {
    }

    public static Map&lt;String, String&gt; getKeys() {
        if (instance == null || isOutdated()) {
            reload();
        }

        return instance.keys;
    }

    private static boolean isOutdated() {
        return instance.timestamp &lt; System.currentTimeMillis() - ONE_DAY;
    }

    private synchronized static void reload() {
        if (instance != null &amp;&amp; !isOutdated()) {
            return;
        }

        instance = new GooglePublicKeys();
        instance.keys = fetchGooglePublicKeys();
        instance.timestamp = System.currentTimeMillis();
    }

    private static Map&lt;String, String&gt; fetchGooglePublicKeys() {
        return parseJson(fetchKeysJson());
    }

    private static String fetchKeysJson() {
        try {
            URLFetchService urlFetch = URLFetchServiceFactory.getURLFetchService();

            HTTPResponse response = urlFetch.fetch(new URL(GOOGLE_PUBLIC_KEYS));
            return new String(response.getContent());
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    private static Map&lt;String, String&gt; parseJson(String json) {
        Gson gson = new Gson();
        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
        return gson.fromJson(json, map.getClass());
    }

}
</code></pre>

<p>That’s it.</p>



        
            <br />
            <div id="disqus_thread"></div>
<script>

/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//yawp.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

        
    </div>                
</div>

    <!-- Footer -->
    <footer class="text-center">
        <div class="footer-above">
            <div class="container">
                <div class="row">
                    <div class="footer-col col-md-4 col-md-offset-4">
                        <ul class="list-inline">
                            <li>
                                <a href="http://github.com/feroult/yawp" target="_blank" class="btn-social btn-outline"><i class="fa fa-fw fa-github"></i></a>
                            </li>
                            <li>
                                <a href="https://twitter.com/yawpio" target="_blank" class="btn-social btn-outline"><i class="fa fa-fw fa-twitter"></i></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <strong>YAWP!</strong> is released under the <a href="https://opensource.org/licenses/MIT" target="_blank">MIT license</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="/assets/js/jquery.js"></script>
    <script src="https://rawgit.com/feroult/yawp/yawp-1.6.8/yawp-client/lib/web/yawp.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/assets/js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="https://cdn.jsdelivr.net/jquery.easing/1.3/jquery.easing.1.3.min.js"></script>
    <script src="/assets/js/classie.js"></script>
    <script src="/assets/js/cbpAnimatedHeader.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="/assets/js/jqBootstrapValidation.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/assets/js/freelancer.js"></script>

    <!-- code formatter -->
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- Place this tag right after the last button or just before your close body tag. -->
    <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>

    
    <script src="/assets/js/left-menu.js"></script>
    

    

    <script>
        yawp.config(function (c) {
            c.baseUrl('http://localhost:8080/api');
        });
    </script>


</body>


</html>
